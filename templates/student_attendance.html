{% extends 'base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Attendance</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .attendance-container {
      max-width: 500px;
      margin: 3rem auto;
      background: #fff0f0;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px #e6303820;
      padding: 2.5rem 2rem;
      text-align: center;
    }
    .attendance-title {
      color: #e63038;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 2rem;
    }
    .attendance-form button {
      font-size: 1.1rem;
      padding: 0.8rem 1.2rem;
      border-radius: 0.8rem;
      background: linear-gradient(90deg, #e63038 0%, #ff7e5f 100%);
      color: #fff;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s;
      margin-top: 1.2rem;
    }
    .attendance-form button:hover {
      background: linear-gradient(90deg, #ff7e5f 0%, #e63038 100%);
      box-shadow: 0 6px 24px #e6303840;
      transform: scale(1.03);
    }
    .empty-state {
      color: #999;
      font-size: 1.1rem;
      margin-top: 2rem;
    }
    .class-name {
      color: #e63038;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    .animated-logo {
      animation: logo-bounce 2.2s cubic-bezier(.68,-0.55,.27,1.55) 0s 1;
      animation-fill-mode: both;
      transition: transform 0.35s cubic-bezier(.77,0,.18,1), filter 0.35s cubic-bezier(.77,0,.18,1);
      cursor: pointer;
    }
    .animated-logo:hover {
      animation: logo-hover-wiggle 0.7s cubic-bezier(.77,0,.18,1);
      animation-fill-mode: both;
      transform: scale(1.13) rotate(-4deg);
      filter: brightness(1.18) saturate(1.15);
    }
    /* Sidebar hamburger hover effect */
    #left-sidebar, #left-sidebar nav a {
      font-family: 'Poppins', sans-serif !important;
    }
    #left-sidebar nav a {
      transition: color 0.2s, background 0.2s;
    }
    #left-sidebar nav a:hover {
      color: #e63038 !important;
      background: #fff0f0;
    }
    #left-sidebar nav a:hover svg *,
    #left-sidebar nav a:focus svg * {
      stroke: #e63038 !important;
    }
  </style>
</head>
<body>
  {% with active_page='attendance' %}
    {% include 'student_header_sidebar.html' %}
  {% endwith %}
  <main style="padding:2rem; max-width:1100px; margin:0 auto;">
    <div class="attendance-container">
      <div class="attendance-title">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" style="vertical-align:middle; margin-right:0.5rem;">
          <rect x="4" y="4" width="16" height="16" rx="4" stroke="#e63038" stroke-width="2"/>
          <path d="M8 10h8M8 14h5" stroke="#e63038" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Take Attendance in Classroom
      </div>
      {% if joined_class %}
        <div class="class-name">{{ joined_class.name }}</div>
        <form class="attendance-form" method="post" action="#">
          {% csrf_token %}
          <button type="submit">Take Attendance</button>
        </form>
        <button id="student-absent-btn" class="btn-absent">Notify Teacher I'm Absent Today</button>
        <div id="student-attendance-history-section" style="margin-top:2.5rem;">
          <h3 style="color:#e63038; font-size:1.2rem; font-weight:800; margin-bottom:1rem;">My Attendance History</h3>
          <table id="student-attendance-history-table" style="width:100%; border-collapse:separate; border-spacing:1.5rem 0.7rem; background:transparent;">
            <thead>
              <tr style="background:#ffe5e5; color:#e63038; font-weight:700;">
                <th style="padding:0.7rem;">Date</th>
                <th style="padding:0.7rem;">Status</th>
                <th style="padding:0.7rem;">Marked At</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          You have not joined any classes yet.<br>
          Please join a class to take attendance.
        </div>
      {% endif %}
    </div>
  </main>
  <script>
  // Hamburger menu logic (same as dashboard)
  const hamburgerBtn = document.getElementById('hamburger-btn');
  const leftSidebar = document.getElementById('left-sidebar');
  const leftSidebarOverlay = document.getElementById('left-sidebar-overlay');
  
  if (hamburgerBtn && leftSidebar && leftSidebarOverlay) {
    hamburgerBtn.onclick = function() {
      leftSidebar.style.left = '0';
      leftSidebarOverlay.style.display = 'block';
      leftSidebar.style.transition = 'left 0.35s cubic-bezier(.77,0,.18,1)';
    };
    leftSidebarOverlay.onclick = function() {
      leftSidebar.style.left = '-270px';
      leftSidebarOverlay.style.display = 'none';
    };
    window.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        leftSidebar.style.left = '-270px';
        leftSidebarOverlay.style.display = 'none';
      }
    });
  }
  
  // Profile sidebar logic
  const profileBtn = document.getElementById('profile-btn');
  const profileSidebar = document.getElementById('profile-sidebar');
  const profileSidebarOverlay = document.getElementById('profile-sidebar-overlay');
  const closeProfileSidebar = document.getElementById('close-profile-sidebar');
  
  if (profileBtn && profileSidebar && profileSidebarOverlay) {
    profileBtn.onclick = function() {
      profileSidebar.style.right = '0';
      profileSidebarOverlay.style.display = 'block';
    };
    profileSidebarOverlay.onclick = function() {
      profileSidebar.style.right = '-350px';
      profileSidebarOverlay.style.display = 'none';
    };
    if (closeProfileSidebar) {
      closeProfileSidebar.onclick = function() {
        profileSidebar.style.right = '-350px';
        profileSidebarOverlay.style.display = 'none';
      };
    }
    // Accessibility: close sidebar with Escape key
    window.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        profileSidebar.style.right = '-350px';
        profileSidebarOverlay.style.display = 'none';
      }
    });
  }
  
  // Logo animation retrigger on load only
  const logo = document.getElementById('attendance-logo');
  if (logo) {
    logo.classList.remove('animated-logo');
    void logo.offsetWidth;
    logo.classList.add('animated-logo');
    // Do NOT toggle the class on hover; let :hover handle the animation
  }
  
  // Take Attendance (Present) logic
  const attendanceForm = document.querySelector('.attendance-form');
  if (attendanceForm) {
    attendanceForm.addEventListener('submit', function(e) {
      e.preventDefault();
      fetch('/student/request_attendance/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ requested_status: 'present' })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          Swal.fire('Request Sent!', data.message, 'success');
        } else {
          Swal.fire('Error', data.message, 'error');
        }
      })
      .catch(() => {
        Swal.fire('Error', 'Network error. Please try again.', 'error');
      });
    });
  }
  
  // Absent (Leave) logic
  const studentAbsentBtn = document.getElementById('student-absent-btn');
  if (studentAbsentBtn) {
    studentAbsentBtn.addEventListener('click', function() {
      fetch('/student/request_attendance/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ requested_status: 'absent' })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          Swal.fire('Request Sent!', data.message, 'success');
        } else {
          Swal.fire('Error', data.message, 'error');
        }
      })
      .catch(() => {
        Swal.fire('Error', 'Network error. Please try again.', 'error');
      });
    });
  }
  
  function fetchStudentAttendanceHistory() {
    fetch('/student/attendance_history/')
      .then(r => r.json())
      .then(data => {
        const tbody = document.querySelector('#student-attendance-history-table tbody');
        if (tbody) {
          tbody.innerHTML = '';
          if (data.status === 'success' && data.attendance.length) {
            data.attendance.forEach(a => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${a.date}</td>
                <td>${a.status.charAt(0).toUpperCase() + a.status.slice(1)}</td>
                <td>${a.marked_at}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="3">No attendance records</td></tr>';
          }
        }
      });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    fetchStudentAttendanceHistory();
  });
  </script>
{% endblock %} 